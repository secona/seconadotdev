---
import { getCollection, getEntry, render } from "astro:content";
import NavbarLayout from "../../layouts/NavbarLayout.astro";
import Card from "../../components/Card.astro";
import { ArrowLeftIcon } from "astro-feather";

export async function getStaticPaths() {
  const blogs = await getCollection("blogs");
  return blogs
    .filter(blog => blog.data.show)
    .map(blog => ({ params: { slug: blog.id } }))
}

const { slug } = Astro.params;
const entry = await getEntry('blogs', slug);

if (!entry || !entry.data.show) throw new Error("blog not found");

const { Content, headings, remarkPluginFrontmatter } = await render(entry);
---

<NavbarLayout pageTitle={entry.data.title + " | Vito Secona"}>
  <div class="blog-wrapper">
    {headings.length > 0 && (
      <aside class="toc-sidebar">
        <Card title="Table of Contents">
          <nav class="toc">
            <ul>
              {headings.map((heading) => (
                <li class={`toc-level-${heading.depth}`}>
                  <a href={`#${heading.slug}`} data-toc-link={heading.slug}>{heading.text}</a>
                </li>
              ))}
            </ul>
          </nav>
        </Card>
      </aside>
    )}
    <main>
      <Card disableTitlebar>
        <div class="entry-title-card">
          <a href="/blog" class="blog-back">
            <ArrowLeftIcon size={16} />
            <span>Back to Blogs</span>
          </a>
          <h1 class="entry-title">{entry.data.title}</h1>
          <div class="entry-metadata">
            <time>
              {new Date(entry.data.publishedAt).toLocaleDateString("en-US", {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
            &mdash; {remarkPluginFrontmatter.minutesRead}
            {entry.data.tags.map((tag) => (
              <span> &mdash; <a href={`/blog?tag=${tag}`} class="entry-tag">#{tag}</a></span>
            ))}
          </div>
        </div>
      </Card>
      {headings.length > 0 && (
        <div class="toc-mobile">
          <Card title="Table of Contents">
            <nav class="toc">
              <ul>
                {headings.map((heading) => (
                  <li class={`toc-level-${heading.depth}`}>
                    <a href={`#${heading.slug}`} data-toc-link={heading.slug}>{heading.text}</a>
                  </li>
                ))}
              </ul>
            </nav>
          </Card>
        </div>
      )}
      <Card disableTitlebar>
        <article class="entry-content">
          <Content />
        </article>
      </Card>
    </main>
  </div>
</NavbarLayout>

<script>
  // ToC scroll tracking
  document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    const headings = Array.from(tocLinks).map(link => {
      const slug = link.getAttribute('data-toc-link');
      return document.getElementById(slug!);
    }).filter(Boolean) as HTMLElement[];

    if (headings.length === 0) return;

    function updateActiveLink() {
      const scrollPosition = window.scrollY + 100;

      let currentHeading = headings[0];
      for (const heading of headings) {
        if (heading.offsetTop <= scrollPosition) {
          currentHeading = heading;
        } else {
          break;
        }
      }

      tocLinks.forEach(link => {
        const slug = link.getAttribute('data-toc-link');
        if (slug === currentHeading?.id) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    window.addEventListener('scroll', updateActiveLink, { passive: true });
    updateActiveLink();
  });

  // Add copy buttons to all code blocks
  document.addEventListener('DOMContentLoaded', function() {
    const codeBlocks = document.querySelectorAll('pre');
    
    codeBlocks.forEach((block) => {
      // Create copy button
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button';
      copyButton.textContent = 'Copy';
      copyButton.setAttribute('aria-label', 'Copy code to clipboard');
      
      // Add button to the code block
      block.appendChild(copyButton);
      
      // Add click event listener
      copyButton.addEventListener('click', async function() {
        const codeElement = block.querySelector('code');
        const codeText = (codeElement?.textContent ?? block.textContent?.replace('Copy', '')) ?? '';
        
        try {
          await navigator.clipboard.writeText(codeText);
          
          // Visual feedback
          copyButton.textContent = 'Copied!';
          copyButton.classList.add('copied');
          
          // Reset after 2 seconds
          setTimeout(() => {
            copyButton.textContent = 'Copy';
            copyButton.classList.remove('copied');
          }, 2000);
          
        } catch (err) {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = codeText;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          
          // Visual feedback
          copyButton.textContent = 'Copied!';
          copyButton.classList.add('copied');
          
          setTimeout(() => {
            copyButton.textContent = 'Copy';
            copyButton.classList.remove('copied');
          }, 2000);
        }
      });
    });
  });
</script>

<style lang="scss" is:global>
@use '../../styles/mixins' as *;

.blog-wrapper {
  display: flex;
  justify-content: center;
  position: relative;
}

.toc-sidebar {
  display: none;
  
  @media (min-width: 1280px) {
    display: block;
    position: fixed;
    left: 1rem;
    top: 6rem;
    width: 280px;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    padding-right: 6px;
    padding-bottom: 6px;
  }

  @media (min-width: 1536px) {
    left: calc((100vw - 56rem) / 2 - 300px);
  }
}

.toc-mobile {
  display: block;

  @media (min-width: 1280px) {
    display: none;
  }
}

.toc {
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  li {
    margin: 0.5rem 0;
    
    a {
      color: var(--gray-700);
      text-decoration: none;
      transition: color 0.2s ease, font-weight 0.2s ease;
      
      &:hover {
        color: var(--blue-600);
      }

      &.active {
        color: var(--blue-600);
        font-weight: 600;
      }
    }
  }

  .toc-level-1 {
    font-weight: 600;
  }

  .toc-level-2 {
    padding-left: 1rem;
  }

  .toc-level-3 {
    padding-left: 2rem;
    @include font-size(sm);
  }

  .toc-level-4 {
    padding-left: 3rem;
    @include font-size(sm);
  }

  .toc-level-5 {
    padding-left: 4rem;
    @include font-size(xs);
  }

  .toc-level-6 {
    padding-left: 5rem;
    @include font-size(xs);
  }
}

main {
  max-width: 56rem;
  padding: 6rem 1.5rem;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;

  @media (max-width: 768px) {
    padding: 4rem 1rem;
    gap: 1rem;
  }

  .entry-title-card {
    padding: 1rem 0;
    display: flex;
    flex-direction: column;
    align-items: flex-start;

    .blog-back {
      color: var(--blue-600);
      text-decoration: underline;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .entry-title {
      @include font-size(4xl);
      margin-bottom: 1rem;
      font-weight: 600;
      line-height: 1.1;
      font-family: "IBM Plex Mono", sans-serif;
    }

    .entry-metadata {
      @include font-size(sm);
      color: var(--gray-500);
      line-height: 1.4;

      .entry-tag:hover {
        color: var(--yellow-500);
      }
    }
  }

  .entry-content {
    line-height: 1.7;
    font-family: "Geist Mono", sans-serif;
    color: var(--gray-800);

    & > * + * {
      margin-top: 1.25rem;
    }

    p {
      margin-bottom: 1rem;
      line-height: 1.8;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: "IBM Plex Mono", sans-serif;
      color: var(--gray-900);
      font-weight: 600;
      
      & > a {
        color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      
      code {
        background-color: var(--blue-50);
        color: var(--blue-800);
        border: 1px solid var(--blue-200);
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: "IBM Plex Mono", sans-serif;
        font-size: inherit;
        font-weight: inherit;
      }
    }

    h1 {
      @include font-size(4xl);
      margin-top: 2rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--gray-300);
      color: var(--gray-900);
      
      &:first-child {
        margin-top: 0.5rem;
      }
    }

    h2 {
      @include font-size(3xl);
      margin-top: 2rem;
      margin-bottom: 1.25rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
      color: var(--gray-900);
    }

    h3 {
      @include font-size(2xl);
      margin-top: 1.75rem;
      margin-bottom: 1rem;
      color: var(--gray-800);
    }

    h4 {
      @include font-size(xl);
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--gray-800);
    }

    h5 {
      @include font-size(lg);
      margin-top: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--gray-700);
    }

    h6 {
      @include font-size(base);
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      color: var(--gray-600);
    }

    strong {
      font-weight: 700;
    }

    em {
      font-style: italic;
    }

    a:not(h1 a, h2 a, h3 a, h4 a, h5 a, h6 a) {
      color: var(--blue-600);
      text-decoration: underline;
      text-decoration-color: var(--blue-300);
      text-decoration-thickness: 1.5px;
      text-underline-offset: 3px;

      &:hover {
        color: var(--blue-700);
        text-decoration-color: var(--blue-600);
      }
    }

    blockquote {
      padding: 1.5rem;
      border-left: 4px solid var(--green-400);
      border-top: 2px solid var(--green-200);
      border-right: 2px solid var(--green-200);
      border-bottom: 2px solid var(--green-200);
      background-color: var(--green-50);
      margin: 1.5rem 0;
      border-radius: var(--rounded);
      position: relative;

      &::before {
        content: "";
        position: absolute;
        top: 0.75rem;
        left: 0.5rem;
        font-size: 2rem;
        color: var(--green-300);
        font-family: serif;
        line-height: 1;
      }

      p {
        margin: 0;
        color: var(--green-800);
        font-style: italic;
        line-height: 1.6;
      }
    }

    ul, ol {
      margin: 1.25rem 0;
      padding-left: 2rem;
      
      li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
      }
    }

    ul {
      list-style-type: disc;

      ul {
        list-style-type: circle;
        margin: 0.5rem 0;

        ul {
          list-style-type: square;
        }
      }
    }

    ol {
      list-style-type: decimal;
    }

    code:not(pre code) {
      @include font-size(sm);
      padding: 0.125rem 0.375rem;
      background-color: var(--blue-50);
      color: var(--blue-800);
      font-weight: 500;
      border: 1px solid var(--blue-200);
      border-radius: 0.25rem;
      font-family: "IBM Plex Mono", sans-serif;
    }

    pre {
      margin: 1.5rem 0;
      padding: 1.5rem;
      border-radius: var(--rounded);
      border: 2px solid var(--gray-800);
      background-color: var(--gray-900);
      overflow-x: auto;
      position: relative;
      
      &::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--blue-400), var(--green-400), var(--yellow-400), var(--red-400));
        border-radius: var(--rounded) var(--rounded) 0 0;
      }
      
      .copy-button {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background-color: var(--gray-700);
        color: var(--gray-100);
        border: 1px solid var(--gray-600);
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        font-family: "IBM Plex Mono", sans-serif;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
        
        &:hover {
          background-color: var(--gray-600);
          border-color: var(--gray-500);
        }
        
        &:active {
          background-color: var(--green-600);
          border-color: var(--green-500);
        }
        
        &.copied {
          background-color: var(--green-600);
          border-color: var(--green-500);
          color: white;
        }
      }
      
      code {
        background: none;
        border: none;
        padding: 0;
        font-family: "IBM Plex Mono", sans-serif;
        color: var(--gray-100);
        font-size: 0.875rem;
        line-height: 1.6;
      }
    }

    hr {
      margin: 1.5rem 0;
      height: 2px;
      background-color: var(--gray-300);
    }

    a {
      color: var(--blue-600);
      text-decoration: none;
      text-decoration: underline;
    }

    table {
      width: 100%;
      margin: 1.5rem 0;
      border-collapse: collapse;
      border: 1px solid var(--gray-300);
      border-radius: var(--rounded);
      overflow: hidden;
      background-color: white;

      th, td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-200);
      }

      th {
        background-color: var(--gray-50);
        font-weight: 600;
        color: var(--gray-900);
        font-family: "IBM Plex Mono", sans-serif;
        @include font-size(sm);
        border-bottom: 2px solid var(--gray-300);
      }

      td {
        background-color: white;
        @include font-size(sm);
        color: var(--gray-700);
      }

      tr:hover td {
        background-color: var(--gray-25);
      }

      tr:last-child td {
        border-bottom: none;
      }
    }
  }
}
</style>
